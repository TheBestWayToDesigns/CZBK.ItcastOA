@{
    Layout = null;
}
@using CZBK.ItcastOA.Model
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>机修制造生产统计表</title>

    <link href="~/Content/themes/icon.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.7.1.min.js"></script>

    <link href="~/Content/themes/default/easyui.css" rel="stylesheet" />
    <script src="~/Scripts/jquery.easyui.min.js"></script>
    <script src="~/Scripts/easyui-lang-zh_CN.js"></script>
    <script src="~/Scripts/datapattern.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <script src="~/Scripts/MyAjaxForm.js"></script>
    <script src="~/Scripts/MyNewJS.js"></script>
    <script src="~/Scripts/jquery.jqprint-0.3.js"></script>
    <script type="text/javascript">
        $.fn.extend({

            resizeDataGrid: function (heightMargin, widthMargin, minHeight, minWidth) {

                var height = $("#dgdiv").height() - heightMargin;
                var width = $("#dgdiv").width() - widthMargin;

                height = height < minHeight ? minHeight : height;

                width = width < minWidth ? minWidth : width;

                $(this).datagrid('resize', {
                    height: height,
                    width: width
                });
            }
        });
        var browser = {
            versions: function () {
                var u = navigator.userAgent, app = navigator.appVersion;
                return {//移动终端浏览器版本信息
                    trident: u.indexOf('Trident') > -1, //IE内核
                    presto: u.indexOf('Presto') > -1, //opera内核
                    webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                    gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                    mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                    android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
                    iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者QQHD浏览器
                    iPad: u.indexOf('iPad') > -1, //是否iPad
                    webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
                };
            }(),
            language: (navigator.browserLanguage || navigator.language).toLowerCase()
        }
        var editIndex = undefined;
        var delflg=0,win=0;
        function endEditing() {//该方法用于关闭上一个焦点的editing状态
            if (editIndex == undefined) {
                return true
            }
            if ($('#tt').datagrid('validateRow', editIndex)) {
                $('#tt').datagrid('endEdit', editIndex);
                editIndex = undefined;
                return true;
            } else {
                return false;
            }
        }
        //提交数据
        function submitForm(index, row, changes) {
            //  alert( row.resultId+"--"+changes.finalResult)daliyResultRate;
            var resultId = row.ID;//信息ID
            if (resultId == "") {
                $.messager.alert('提醒', '错误没有选中修改信息');
                $("#tt").datagrid('reload');
                return;
            }

            //  var finalRate = row.BaoJiaMoney;//期末比例
            var finalRusult = changes.BaoJiaMoney;//期末成绩
            var r = /^-?[1-9]/;//判断输入的是正整数
            if (!r.test(finalRusult)) {
                $.messager.alert('提醒', '请输入正整数！');
                return;
            }
            $.ajax({
                type: "post",
                async: false,
                url: "/MasterBaojia/editMoney",
                data: {
                    "resultId": resultId,
                    "finalRusult": finalRusult
                },
                success: function (data) {
                    if (data.ret == true) {
                        $("#tt").datagrid('reload');
                    }
                }
            })
        }
        $(function () {
            //datagrid数据表格ID
            var datagridId = 'tt';

            GetDate()
           // $(".layout-button-left").click();
            //loadData_qian()
            // 当窗口大小发生变化时，调整DataGrid的大小
            $(window).resize(function () {
                $('#' + datagridId).resizeDataGrid(0,0, 200, 500);
            });
            $("#editDiv").css("display", "none");
            loadData();

            $("#Ygedit").click(function () {
                cleanDatagrid();
                stlYgtab();
                $("#adddatasDiv").hide()
                $("#AddPersonInfoBtnDiv").show()
            })
            $("#Qingkong").click(function(){
                Qingkong();
            })
            $("#adddatas").click(function () {
                AdddataInfo()
            })
            $("#sltdata").click(function () {
                loadData();
                $("#adddatasDiv").show()
                $("#AddPersonInfoBtnDiv").hide()
            })
            $("#AddPersonInfoBtn").click(function () {
                AddPersonInfo();
            })

            $('#sltczz').combobox({
                onChange: function (newValue, oldValue) {
                    $.post("/Sltjxzz/GetPersonInfo", { "id": newValue }, function (rt) {
                        $("#itGongzhong").val(rt.ret.Job_Name)
                        $("#itwage").val(rt.ret.Wage_slt)
                        $("#ithours").val(rt.ret.HoursWage)
                        })
                }
            });
            //选择人员后显示工资 工种及工时
            //$("#UserIDForAddPerson").combobox({
            //    onSelect: function () {
            //        alert(1)
            //        var BMID = $("#UserIDForAddPerson").combobox("getValue");
            //        $.post("/sltxzz/GetPersonInfo", { "id": BMID }, function (rt) {
            //            alert(rt);
            //        })
            //        //<input id="itGongzhong" type="text" readonly /> 
            //        //    <td><input id="itwage" type="text" readonly /> </td>
            //        //    <td><input id="ithours" type="text" readonly /> </td>

            //    }
            //})
        });

        //添加人员信息
        function AddPersonInfo() {
            $("#AddPersonInfoDIV").css("display", "block");
            $('#AddPersonInfoDIV').dialog({
                title: "添加员工信息",
                width: 450,
                height: 400,
                collapsible: true,
                resizable: true,
                modal: true,
                buttons: [{
                    text: '确定',
                    iconCls: 'icon-ok',
                    handler: function () {
                        var UserID = $("#UserIDForAddPerson").combobox("getValue");
                        if (UserID.trim().length <= 0) {
                            $.messager.alert("提示", "请选择员工！");
                            return;
                        }
                        if ($("#Job_Name").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写工种！");
                            return;
                        }
                        if ($("#HoursWage").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写时薪！");
                            return;
                        }
                        if ($("#Wage_slt").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写Wage_slt！");
                            return;
                        }
                        $("#addpersoninfofrom").submit();//提交表单
                    }
                }, {
                    text: '取消',
                    handler: function () {
                        $('#AddPersonInfoDIV').dialog('close');
                    }
                }]
            });
        }
        function AdddataInfo() {
            $("#adddiv").css("display", "block");
            $('#adddiv').dialog({
                title: "添加信息",
                width:$(this).width()*0.8,
                height: 400,
                collapsible: true,
                resizable: true,
                modal: true,
                buttons: [{
                    text: '确定',
                    iconCls: 'icon-ok',
                    handler: function () {
                        var UserID = $("#UserIDForAddPerson").combobox("getValue");
                        if (UserID.trim().length <= 0) {
                            $.messager.alert("提示", "请选择员工！");
                            return;
                        }
                        if ($("#Job_Name").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写工种！");
                            return;
                        }
                        if ($("#HoursWage").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写时薪！");
                            return;
                        }
                        if ($("#Wage_slt").val().trim().length <= 0) {
                            $.messager.alert("提示", "请填写Wage_slt！");
                            return;
                        }
                        $("#addpersoninfofrom").submit();//提交表单
                    }
                }, {
                    text: '取消',
                    handler: function () {
                        $('#AddPersonInfoDIV').dialog('close');
                    }
                }]
            });
        }
        function afterAddPersonInfo(data) {
            if (data.ret == "ok") {
                try {
                    $('#tt').datagrid('reload');
                    $('#AddPersonInfoDIV').dialog('close');
                }
                catch (e) {
                }
            }  else {
                $.messager.alert("提醒", "操作错误!!", "error");
            }
        }
        function editPersonData() {
            var row = $('#tt').datagrid('getSelected');
            $.post("/SltJxzz/GetPersonInfo", { "id": row.ID }, function (ret) {
                $("#UserIDForAddPerson").combobox("setValue", ret.ret.UserID);
                $("#Job_Name").val(ret.ret.Job_Name);
                $("#HoursWage").val(ret.ret.HoursWage);
                $("#Wage_slt").val(ret.ret.Wage_slt);
                $("#PersonInfoID").val(ret.ret.ID);
            })
            AddPersonInfo();
        }
        //清空datagrid数据
        function cleanDatagrid() {
            var item = $('#tt').datagrid('getRows');
            if (item) {
                for (var i = item.length - 1; i >= 0; i--) {
                    var index = $('#tt').datagrid('getRowIndex', item[i]);
                    $('#tt').datagrid('deleteRow', index);
                }
            }
        }
        function loadData_qian()
        {

            var UpTime = $('#Stime').combobox('getValue');

            if (UpTime.length <= 0) {
                $.messager.alert("提示", "开始时间不可为空！")
                return;
            }

            var DwTime = $('#Otime').combobox('getValue');
            if (DwTime.length <= 0) {
                $.messager.alert("提示", "结束时间不可为空！")
                return;
            }

            var Jhname = $('#Jhname').combobox('getValue');

            var addUser = $('#addUser').combobox('getValue');
            var SHuser = $('#SHuser').combobox('getValue');
            var CPtext = $('#CPtext').combobox('getValue');
            var shzt = $("#shzt").combobox('getValue');

            var pars = {
                
            };
            loadData(pars);
        }
        function stlYgtab(pars) {
            $('#tt').datagrid({
                url: '/sltjxzz/sltperson',
                title: '员工信息管理',
                width: $("#dgdiv").width(),
                height: $("#dgdiv").height() - 30,
                fitColumns: true, //列自适应
                nowrap: true,
                rownumbers: true,
                idField: 'ID',//主键列的列明
                loadMsg: '正在加载权限的信息...',
                pagination: true,//是否有分页
                singleSelect: true,//是否单行选择
                pageSize: 25,//页大小，一页多少条数据
                pageNumber: 1,//当前页，默认的
                pageList: [15, 25, 35],
                queryParams: pars,//往后台传递参数
                columns: [[//c.UserName, c.UserPass, c.Email, c.RegTime
                    { field: 'Name', title: '姓名', align: 'center' },
                    { field: 'Job_Name', title: '工种', align: 'center'},
                    { field: 'HoursWage', title: '时薪', align: 'center' },
                   { field: 'Wage_slt', title: '工资', align: 'center' },
                   {
                       field: 'AddTime', title: '创建时间', align: 'center',
                       formatter: function (value, row, index) {
                           if (value != null)
                           { return (eval(value.replace(/\/Date\((\d+)\)\//gi, "new Date($1)"))).pattern("yyyy-M-d"); }
                           else
                           { return value }
                       }
                   },  {
                       field: 'Operator', title: '操作', align: 'center',
                        formatter: function (value, row, index) {
                            var str = "<a href='javascript:editPersonData()' class='l-btn' style='margin:0px 5px;padding:2px 8px '" +
                                "' class=' deletes' >修改</a>" + "<a href='javascript:delPersonData()' class='l-btn' style='margin:0px 5px;padding:2px 8px '" +
                                "' class=' deletes' >删除</a>";

                            return str;
                        }
                    }

                ]],
                toolbar: "#AddPersonInfoBtnDiv",
                onLoadSuccess: function () {
              
                }
            });
        }
        function loadData(pars) {
            $('#tt').datagrid({
                url: '/Sltjxzz/Getdata',
                title: '信息统计表',
                width: $("#dgdiv").width(),
                height: $("#dgdiv").height()-30,
                fitColumns: true, //列自适应
                nowrap: true,
                rownumbers: true,
                idField: 'ID',//主键列的列明
                loadMsg: '正在加载权限的信息...',
                pagination: true,//是否有分页
                singleSelect: true,//是否单行选择
                pageSize: 25,//页大小，一页多少条数据
                pageNumber: 1,//当前页，默认的
                pageList: [15, 25, 35],
                queryParams: pars,//往后台传递参数

                columns: [[//c.UserName, c.UserPass, c.Email, c.RegTime
                    {
                        field: 'Addtime', title: '创建时间',
                        formatter: function (value, row, index) {
                            if (value != null)
                            { return (eval(value.replace(/\/Date\((\d+)\)\//gi, "new Date($1)"))).pattern("yyyy-M-d"); }
                            else
                            { return value }
                        }
                    },
                      { field: 'bumne', title: '用工部门' },
                     {
                         field: 'Operator', title: '操作',
                         formatter: function (value, row, index) {
                             var str = "<a href='javascript:void(0)' ids='" + row.ID +
                                 "' class=' deletes' >查看</a>";

                             return str;
                         }
                     }

                ]],
                toolbar: "#adddatasDiv",
                onLoadSuccess: function () {
         
                }
            });
        }
       
        //将序列化成json格式后日期(毫秒数)转成日期格式
        function ChangeDateFormat(cellval) {
            var date = new Date(parseInt(cellval.replace("/Date(", "").replace(")/", ""), 10));
            var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
            var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
            return date.getFullYear() + "-" + month + "-" + currentDate;
        }
        function bool_click()
        {
            $.post("/ActionInfo/btnbool", { "id": "" }, function (serverData) {
                if (serverData == "True") {
                    $("#ZTtext").val("开启");
                    $("#btnbool").val("关闭");
                }
                else {
                    $("#ZTtext").val("关闭");
                    $("#btnbool").val("开启");
                }
            });
        }
        //修改完成以后调用该方法
        function afterEdit(data) {
            if (data.ret == "ok") {
                $('#editDiv').dialog('close');
                $('#tt').datagrid('reload');
            } else {
                $.messager.alert("提醒", "修改数据错误!!", "error");
            }
        }
        //数字验证
        function num(obj) {
            obj.value = obj.value.replace(/[^\d.]/g, ""); //清除"数字"和"."以外的字符
            obj.value = obj.value.replace(/^\./g, ""); //验证第一个字符是数字
            obj.value = obj.value.replace(/\.{2,}/g, "."); //只保留第一个, 清除多余的
            obj.value = obj.value.replace(".", "$#$").replace(/\./g, "").replace("$#$", ".");
            obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/, '$1$2.$3'); //只能输入两个小数
        }
        //获取当前时间
        function GetDate()
        {
            var myDate = new Date();
            var year = myDate.getFullYear();
            //获取当前月
            var month = myDate.getMonth() + 1;

            var new_date = new Date(year, month, 1);                //取当年当月中的第一天


            var date_count = (new Date(new_date.getTime() - 1000 * 60 * 60 * 24)).getDate();//获取当月的天数

            var last_date = new Date(new_date.getTime() - 1000 * 60 * 60 * 24);//获得当月最后一天的日期

            var year = new_date.getFullYear();
            //获取当前月
            var month = new_date.getMonth();
            //获取当前日
            var date = new_date.getDate();
            var now = year + '-' + p(month) + "-" + p(date);

            $('#Stime').datebox('setValue', now);
            year = last_date.getFullYear();
            //获取当前月
            month = last_date.getMonth() +1;
            //获取当前日
            date = last_date.getDate();
            now = year + '-' + p(month) + "-" + p(date);
            $('#Otime').datebox('setValue', now);

        }
        function p(s) {
            return s < 10 ? '0' + s : s;
        }
        function Qingkong() {

            $('#Jhname').combobox('clear');
            $('#addUser').combobox('clear');
            $('#SHuser').combobox('clear');
            $('#CPtext').combobox('clear');

            $('#shzt').combobox('clear');

            //var addUser = $('#addUser').combobox('getValue');
            //var SHuser = $('#SHuser').combobox('getValue');
            //var CPtext = $('#CPtext').combobox('getValue');
        }
    </script>
    <style>
        html, body {
            margin: 0px;
            padding: 0px;
        }

        .btnlink a {
            width: 90%;
            margin-top: 3px;
        }

        .tab {
            margin-left: auto;
            margin-right: auto;
            width: 80%;
            text-align: center;
        }
    </style>
</head>
<body class="easyui-layout">
    <div data-options="region:'west',split:true,title:'选项'" id="CkHide" class="easyui-panel btnlink" style="width:120px; padding:8px">
        <a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g1',selected:true" id="sltdata">查询单据</a>
        <a href="#" class="easyui-linkbutton" data-options="toggle:true,group:'g1'" id="Ygedit">员工信息</a>
    </div>
    <div data-options="region:'center',title:'数据报表'" id="dgdiv">

        <table id="tt" class="easyui-datagrid" style="width: 700px; " title="标题，可以使用代码进行初始化，也可以使用这种属性的方式" iconcls="icon-edit"
              >
            <thead data-options="frozen:true ">
                <tr>
                    <th data-options="field:'ck',checkbox: true, align: 'left', width: 30"></th>
                    <th data-options="field:'ID', width: 40">编号</th>
                </tr>
            </thead>
        </table>

    </div> 
    <!-------添加员工信息按钮-------->
    <div id="AddPersonInfoBtnDiv" style="padding:5px;height:auto">
        <div style="margin-bottom:5px">
            <a href="#" class="easyui-linkbutton" id="AddPersonInfoBtn" iconCls="icon-add" plain="true">添加员工信息</a>
        </div>
    </div>
    <!-------添加数据-------->
    <div id="adddatasDiv" style="padding:5px;height:auto">
        <div style="margin-bottom:5px">
            <a href="#" class="easyui-linkbutton" id="adddatas" iconCls="icon-add" plain="true">新增</a>
        </div>
    </div>
    <!---------------添加/修改员工信息----------------->
    <div id="AddPersonInfoDIV" style="height:100%; width:100%;display:none">
        @using (Ajax.BeginForm("AddeditSltPer", "SltJxzz", new { }, new AjaxOptions() { HttpMethod = "post", OnSuccess = "afterAddPersonInfo" }, new { id = "addpersoninfofrom" }))
        {<table id="AddPersonInfoTab">
            <tr style="display:none"><td>编号</td><td><input type="text" class="easyui-textbox" name="ID" id="PersonInfoID" /></td></tr>
            <tr><td>员工</td>
                    <td>
                        <!--从数据库取值的下拉菜单-->
                        <input class="easyui-combobox" id="UserIDForAddPerson"
                               name="UserID"
                               url="/SltJxzz/GetYuanGongList"
                               valueField="ID"
                               textField="Name"
                               panelHeight="auto"
                               style="width:100px" />
                    </td>
            </tr>
            <tr><td>工种</td><td><input type="text" class="easyui-textbox" name="Job_Name" id="Job_Name" /></td></tr>
             <tr><td>时薪</td><td><input type="text" class="easyui-textbox" name="HoursWage" id="HoursWage" /></td></tr>
             <tr><td>工资</td><td><input type="text" class="easyui-textbox" name="Wage_slt" id="Wage_slt" /></td></tr>
        </table>
            <table>
                <tbody id="Selebody"></tbody>
            </table>
        }
    </div>
    <!---------------修改用户信息--------------------->
    <div id="adddiv" style="height:100%; width:100%;display:none">
        @using (Ajax.BeginForm("Sltjxzz", "addDayBb", new { }, new AjaxOptions() { HttpMethod = "post", OnSuccess = "afterEdit" }, new { id = "bollForm" }))
        {
            <table style="text-align:center">
                <tr>
                    <td>报表时间</td>
                    <td>
                        <input class="easyui-datebox" name="Wtime" />
                    </td>
                </tr>
                <tr><td>零件名称</td><td colspan="5"><input type="text" name="ImgName_ID" class="easyui-textbox" style="width:100%" /></td></tr>
                <tr>
                    <td>操作者</td>
                    <td>

                        @{


                            <select id="sltczz" class="easyui-combobox" name="UPslt_ID" style="width:80px;">
                                @{foreach (User_Person_slt Item in ViewBag.sltUser)
                                    {
                                        <option value="@Item.ID">@Item.UserInfo.UName</option>
                                    }
                                }
                            </select>

                        }                      
                        
                    </td>
                    <td>设备编号</td>
                    <td>
                        @{

                            
                                <select id="str_1" class="easyui-combobox" name="Seb_number_ID" style="width:80px;">
                                    @{foreach (Seb_Number Item in ViewBag.ljname)
                                        {
                                                <option value="@Item.ID">@Item.Ttext</option>
                                        }
                                    }
                                </select>
                             
                        }
                    </td>
                    <td>部门名称</td>
                    <td>
                        <input class="easyui-combobox " id="UpBumen_id"
                               name="BuMenid"
                               url="/BillPrint/GetBumen"
                               valueField="ID"
                               textField="MyTexts"
                               panelHeight="auto" style="width:100px" />
                    </td>

                </tr>
                <tr>
                    <td>计划开始时间</td>
                    <td>
                        <input id="" type="text" name="StupTime" class="easyui-datebox" />
                    </td>
                    <td>实际完成日期</td>
                    <td><input id="" type="text" name="OverTime"   class="easyui-datebox" /> </td>
                    <td>完工程度</td>
                    <td><input id="" type="text" name="OverTime"   onkeyup="num(this)"/> </td>
                </tr>
                <tr>
                    <td>工种</td>
                    <td>
                       <input id="itGongzhong" name="OverTime"  type="text" readonly /> 
                    </td>
                    <td>工资</td>
                    <td><input id="itwage" type="text" name="OverTime"  readonly /> </td>
                    <td>工时</td>
                    <td><input id="ithours" type="text" name="OverTime"  readonly /> </td>

                </tr>
                <tr>
                    <td>零件图号</td>
                    <td>
                        <input id="" type="text"  />
                    </td>
                    <td>数量</td>
                    <td><input id="" type="text"  name="OverTime"  onkeyup="num(this)" /> </td>
                    <td>总量</td>
                    <td><input id="" type="text"  name="OverTime"   onkeyup="num(this)" /> </td>

                </tr>
                <tr>
                    <td>合格数量</td>
                    <td>
                        <input id="" type="text" name="OverTime"  onkeyup="num(this)" />
                    </td>
                    <td>不合格数量</td>
                    <td><input id="" type="text" name="OverTime"  onkeyup="num(this)"/> </td>
                    <td>废品数量</td>
                    <td><input id="" type="text" name="OverTime"   onkeyup="num(this)"/> </td>

                </tr>
                
                <tr>
                    <td>计划工时</td>
                    <td>
                        <input id="" type="text" name="OverTime"  onkeyup="num(this)"/>
                    </td>
                    <td>实际工时</td>
                    <td><input id="" type="text" name="OverTime"  onkeyup="num(this)"/> </td>
                    <td>是否休息</td>
                    <td><select class="easyui-combobox"  name="OverTime" >
                        <option value="0">是</option>                        
                            <option value="1">否</option>                        
                        </select> </td>
                </tr>
            </table>
           
        }
    </div>
</body>
</html>
